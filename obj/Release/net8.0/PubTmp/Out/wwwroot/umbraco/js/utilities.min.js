!function(window){const isArray=val=>Array.isArray(val)||val instanceof Array,extend=angular.extend,isUndefined=val=>void 0===val,isString=val=>"string"==typeof val,isNumber=val=>"number"==typeof val,toJsonReplacer=(key,value)=>{var val=value;return"string"==typeof key&&"$"===key.charAt(0)&&"$"===key.charAt(1)?val=void 0:(obj=>obj&&obj.window===obj)(value)?val="$WINDOW":value&&window.document===value?val="$DOCUMENT":(obj=>obj&&obj.$evalAsync&&obj.$watch)(value)&&(val="$SCOPE"),val};let _utilities={noop:()=>{},copy:(src,dst)=>angular.copy(src,dst),isArray:isArray,equals:(a,b)=>angular.equals(a,b),extend:extend,isFunction:val=>"function"==typeof val,isUndefined:isUndefined,isDefined:val=>!isUndefined(val),isString:isString,isNumber:isNumber,isObject:val=>null!==val&&"object"==typeof val,fromJson:val=>isString(val)?JSON.parse(val):val,toJson:(obj,pretty)=>{if(!isUndefined(obj))return isNumber(pretty)||(pretty=pretty?2:null),JSON.stringify(obj,toJsonReplacer,pretty)},forEach:(obj,iterator)=>obj&&isArray(obj)?obj.forEach(iterator):obj,MediaUploader:function(Upload,mediaHelper,mediaTypeHelper,localizationService,overlayService,mediaTypeResource){const umbracoSettings=Umbraco.Sys.ServerVariables.umbracoSettings,allowedFileTypes=`${mediaHelper.formatFileTypes(umbracoSettings.allowedUploadFiles)},${mediaHelper.formatFileTypes(umbracoSettings.imageFileTypes)}`,disallowedFileTypes=mediaHelper.formatFileTypes(umbracoSettings.disallowedUploadFiles),maxFileSize=""!==umbracoSettings.maxFileSize?`${umbracoSettings.maxFileSize} KB`:"",events={},translations={};let initialized=!1,uploadURL="",allowedMediaTypes=[],queue=[],invalidEntries=[];function _rejectMediaEntry(mediaEntry,reason){mediaEntry.error=!0,mediaEntry.errorType={},mediaEntry.errorType[reason.type]=!0,mediaEntry.errorText=reason.message,invalidEntries.push(mediaEntry),_emit("mediaEntryRejected",{mediaEntry:mediaEntry})}function _processQueue(){const nextItem=queue.shift();nextItem?function _getMatchedMediaType(file){return new Promise((resolve,reject)=>{const uploadFileExtension=mediaHelper.getFileExtension(file.name),matchedMediaTypes=mediaTypeHelper.getTypeAcceptingFileExtensions(allowedMediaTypes,[uploadFileExtension]);if(0===matchedMediaTypes.length)return void reject();if(1===matchedMediaTypes.length)return void resolve(matchedMediaTypes[0]);const matchedMediaTypesNoFile=matchedMediaTypes.filter(mediaType=>"File"!==mediaType.alias);1!==matchedMediaTypesNoFile.length?matchedMediaTypes.length>1&&function _chooseMediaTypeDialog(mediaTypes,file){return new Promise((resolve,reject)=>{const dialog={view:"itempicker",filter:mediaTypes.length>8,availableItems:mediaTypes,submit:function(model){resolve(model.selectedItem),overlayService.close()},close:function(){reject(),overlayService.close()}};dialog.title=translations.selectMediaTypeDialogTitle,dialog.subtitle=file.name,overlayService.open(dialog)})}(matchedMediaTypes,file).then(selectedMediaType=>{resolve(selectedMediaType)},()=>{reject()}):resolve(matchedMediaTypesNoFile[0])})}(nextItem.file).then(mediaType=>{nextItem.mediaEntry.mediaTypeAlias=mediaType.alias,nextItem.mediaEntry.$icon=mediaType.icon,function _upload(queueItem){const mediaEntry=queueItem.mediaEntry;_emit("uploadStarted",{mediaEntry:mediaEntry}),Upload.upload({url:uploadURL,file:queueItem.file}).progress(function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total,10);mediaEntry.$uploadProgress=progressPercentage}).success(function(data){_emit("uploadSuccess",{mediaEntry:mediaEntry,...data}),_processQueue()}).error(function(error){_emit("uploadError",{mediaEntry:mediaEntry}),_rejectMediaEntry(mediaEntry,{type:"server",message:error.Message}),_processQueue()})}(nextItem)},()=>{_rejectMediaEntry(nextItem.mediaEntry,{type:"pattern",message:translations.disallowedFileType}),_processQueue()}):_emit("queueCompleted")}function _emit(name,data){events[name]&&events[name].forEach(callback=>callback({name:name},data))}return{init:function init(options){return uploadURL=options.uploadURL,new Promise((resolve,reject)=>{const promises=[mediaTypeResource.getAllFiltered(options.allowedMediaTypeAliases),localizationService.localizeMany(["media_disallowedFileType","media_maxFileSize","defaultdialogs_selectMediaType"])];Promise.all(promises).then(values=>{const mediaTypes=values[0],translationValues=values[1];allowedMediaTypes=mediaTypes,translations.disallowedFileType=translationValues[0],translations.maxFileSize=translationValues[1]+" "+maxFileSize,translations.selectMediaTypeDialogTitle=translationValues[2],initialized=!0,resolve()},reason=>{reject(reason)})})},requestUpload:function requestUpload(files){if(!initialized)throw"MediaUploader is not initialized";const validBatch=[];(function createUploadItemsFromFiles(files){return files.map(file=>{const mediaEntry={key:String.CreateGuid(),name:file.name,$uploadProgress:0,$dataURL:""};return file.type.includes("image")?Upload.base64DataUrl(file).then(function(url){mediaEntry.$dataURL=url}):mediaEntry.$extension=mediaHelper.getFileExtension(file.name),{mediaEntry:mediaEntry,file:file}})})(files).forEach(item=>{const isAllowedFileType=Upload.validatePattern(item.file,allowedFileTypes),isDisallowedFileType=Upload.validatePattern(item.file,disallowedFileTypes),underMaxFileSize=!maxFileSize||function validateMaxFileSize(file,val){return file.size-.1<=Upload.translateScalars(val)}(item.file,maxFileSize);if(isAllowedFileType&&!isDisallowedFileType&&underMaxFileSize)return function _acceptMediaEntry(mediaEntry){_emit("mediaEntryAccepted",{mediaEntry:mediaEntry})}(item.mediaEntry),void validBatch.push(item);isAllowedFileType&&!isDisallowedFileType?underMaxFileSize||_rejectMediaEntry(item.mediaEntry,{type:"maxSize",message:translations.maxFileSize}):_rejectMediaEntry(item.mediaEntry,{type:"pattern",message:translations.disallowedFileType})}),function _addItemsToQueue(queueItems){queue=[...queue,...queueItems]}(validBatch),_emit("queueStarted"),_processQueue()},on:function on(name,callback){if("function"==typeof callback)return events[name]=events[name]||[],events[name].push(callback),function(){events[name]=events[name].filter(cb=>cb!==callback)}}}}};void 0===window.Utilities&&(window.Utilities=_utilities)}(window);